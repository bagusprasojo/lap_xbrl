{% extends "base.html" %}

{% block title %}Template Laporan - IDX XBRL MVP{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">Buat Template</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_template">
                    {{ template_form.non_field_errors }}
                    {% for field in template_form %}
                        <div class="mb-3">
                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                            {% if field.errors %}
                                <div class="text-danger small">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <button class="btn btn-primary">Simpan Template</button>
                </form>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>{% if editing_item %}Edit Item: {{ editing_item.label }}{% else %}Tambah Item{% endif %}</span>
                {% if editing_item %}
                    <a class="btn btn-sm btn-light" href="{% url 'manage_templates' %}">Batal</a>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% if editing_item %}
                        <input type="hidden" name="action" value="update_item">
                        <input type="hidden" name="item_id" value="{{ editing_item.id }}">
                    {% else %}
                        <input type="hidden" name="action" value="create_item">
                    {% endif %}
                    {{ item_form.non_field_errors }}
                    {% for field in item_form %}
                        <div class="mb-3">
                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                            {% if field.errors %}
                                <div class="text-danger small">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <button class="btn btn-secondary">
                        {% if editing_item %}Simpan Perubahan{% else %}Tambah Item{% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-7">
        <div class="card shadow-sm">
            <div class="card-header bg-light">Daftar Template</div>
            <div class="card-body">
                {% if templates %}
                    {% for template in templates %}
                        <div class="mb-4 border rounded p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="mb-1">{{ template.name }}</h5>
                                    {% if template.description %}
                                        <p class="text-muted mb-0">{{ template.description }}</p>
                                    {% endif %}
                                </div>
                                <form method="post" onsubmit="return confirm('Hapus template {{ template.name }} beserta itemnya?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete_template">
                                    <input type="hidden" name="template_id" value="{{ template.id }}">
                                    <button class="btn btn-sm btn-outline-danger">Hapus Template</button>
                                </form>
                            </div>
                            {% if template.items.all %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Label</th>
                                            <th>Primary Fact</th>
                                            <th>Level</th>
                                            <th>Fallback</th>
                                            <th>Aksi</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for item in template.items.all %}
                                            <tr>
                                                <td>{{ item.order }}</td>
                                                <td>{{ item.label }}</td>
                                                <td>{{ item.primary_fact }}</td>
                                                <td>{{ item.level }}</td>
                                                <td>
                                                    {% if item.fallback_list %}
                                                        {{ item.fallback_list|join:", " }}
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-nowrap">
                                                    <a class="btn btn-sm btn-outline-primary"
                                                       href="{% url 'manage_templates' %}?edit_item={{ item.id }}">
                                                        Edit
                                                    </a>
                                                    <form method="post" class="d-inline">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="delete_item">
                                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                                        <button class="btn btn-sm btn-outline-danger"
                                                                onclick="return confirm('Hapus item {{ item.label }}?')">
                                                            Hapus
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">Belum ada item.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-0">Belum ada template.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
