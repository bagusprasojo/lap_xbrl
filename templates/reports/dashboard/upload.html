{% extends "base.html" %}

{% block title %}Upload XBRL - IDX XBRL MVP{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                Upload File XBRL
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.non_field_errors }}
                    <div class="mb-3">
                        <label class="form-label">{{ form.file.label }}</label>
                        {{ form.file }}
                        {% if form.file.errors %}
                            <div class="text-danger small">{{ form.file.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-check mb-3">
                        {{ form.overwrite }}
                        <label class="form-check-label" for="{{ form.overwrite.id_for_label }}">
                            {{ form.overwrite.label }}
                        </label>
                        <div class="form-text">{{ form.overwrite.help_text }}</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Proses Upload</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-light d-flex flex-wrap align-items-center justify-content-between gap-2">
                <span>Riwayat Upload Terbaru</span>
                <form method="get" class="d-flex gap-2">
                    <input type="text" name="q" class="form-control form-control-sm"
                           placeholder="Cari emiten/periode..." value="{{ query }}">
                    <button class="btn btn-outline-primary btn-sm" type="submit">Cari</button>
                </form>
            </div>
            <div class="card-body">
                {% if latest_filings %}
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle mb-0">
                            <thead class="table-secondary">
                            <tr>
                                <th>Kode Emiten</th>
                                <th>Periode Laporan</th>
                                <th>Tgl Upload</th>
                                <th>Aksi</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for filing in latest_filings %}
                                <tr>
                                    <td>
                                        <a href="{% url 'filing_detail' filing.id %}">
                                            {{ filing.company.ticker }}
                                        </a>
                                    </td>
                                    <td>{{ filing.period_label }}</td>
                                    <td>{{ filing.uploaded_at|date:"d M Y H:i" }}</td>
                                    <td class="text-nowrap">
                                        <form method="post" action="{% url 'delete_filing' filing.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button
                                                type="submit"
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Hapus filing ini?');"
                                            >
                                                Hapus
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if latest_filings.paginator.num_pages > 1 %}
                        <nav class="mt-3" aria-label="Pagination">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item {% if latest_filings.number == 1 %}disabled{% endif %}">
                                    {% if latest_filings.number != 1 %}
                                        <a class="page-link" href="?q={{ query }}&page=1" aria-label="Halaman pertama">
                                            &laquo;&laquo;
                                        </a>
                                    {% else %}
                                        <span class="page-link" aria-label="Halaman pertama">&laquo;&laquo;</span>
                                    {% endif %}
                                </li>
                                <li class="page-item {% if not latest_filings.has_previous %}disabled{% endif %}">
                                    {% if latest_filings.has_previous %}
                                        <a class="page-link" href="?q={{ query }}&page={{ latest_filings.previous_page_number }}"
                                           aria-label="Sebelumnya">
                                            &laquo;
                                        </a>
                                    {% else %}
                                        <span class="page-link" aria-label="Sebelumnya">&laquo;</span>
                                    {% endif %}
                                </li>
                                {% for page_num in latest_filings.paginator.page_range %}
                                    {% if page_num == latest_filings.number %}
                                        <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                                    {% elif page_num >= latest_filings.number|add:-2 and page_num <= latest_filings.number|add:2 %}
                                        <li class="page-item">
                                            <a class="page-link" href="?q={{ query }}&page={{ page_num }}">{{ page_num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                <li class="page-item {% if not latest_filings.has_next %}disabled{% endif %}">
                                    {% if latest_filings.has_next %}
                                        <a class="page-link" href="?q={{ query }}&page={{ latest_filings.next_page_number }}"
                                           aria-label="Berikutnya">
                                            &raquo;
                                        </a>
                                    {% else %}
                                        <span class="page-link" aria-label="Berikutnya">&raquo;</span>
                                    {% endif %}
                                </li>
                                <li class="page-item {% if latest_filings.number == latest_filings.paginator.num_pages %}disabled{% endif %}">
                                    {% if latest_filings.number != latest_filings.paginator.num_pages %}
                                        <a class="page-link" href="?q={{ query }}&page={{ latest_filings.paginator.num_pages }}"
                                           aria-label="Halaman terakhir">
                                            &raquo;&raquo;
                                        </a>
                                    {% else %}
                                        <span class="page-link" aria-label="Halaman terakhir">&raquo;&raquo;</span>
                                    {% endif %}
                                </li>
                            </ul>
                        </nav>
                    {% endif %}
                {% else %}
                    <p class="text-muted mb-0">Belum ada data.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="mt-4">
        <div class="alert alert-info">
            <strong>Catatan Validasi:</strong> sistem hanya memeriksa kode emiten dan periode berdasarkan metadata XBRL.
            Jika terjadi error parsing, detail akan tampil di sini sebagai peringatan.
        </div>
    </div>
</div>
{% endblock %}
